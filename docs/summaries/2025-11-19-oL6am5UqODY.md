# Agents Gone Wild? Use Tool Call Limits in LangChainJS to Keep Them in Check

**Channel:** LangChain
**Published:** 2025-11-19
**Video:** [Watch on YouTube](https://youtube.com/watch?v=oL6am5UqODY)

---

# LangChain 教學：用 Tool Call Middleware 控制你的 AI 代理

## 重點摘要
影片介紹了 LangChain 中的「Tool Call Middleware」功能，它提供了一種無需修改系統提示(System Prompt)即可為 AI 代理(Agent)的工具使用設定費率、額度或次數上限的方法。這能有效避免代理過度使用付費 API，從而控制成本。

## 故事大綱
- **開場**：影片開頭點出一個常見問題：AI 代理可能會無節制地呼叫 API，導致意想不到的高額費用。講者以一個「發送簡訊」的代理為例，如果用戶的額度只夠發兩則，但代理卻發了五則，開發者就得承擔額外成本。
- **中段**：為了解決此問題，影片介紹了 Tool Call Middleware 的概念。它會在模型決定呼叫工具後立即介入，攔截並計算呼叫次數。開發者可以針對特定工具設定兩種範圍的限制：`thread`（整個對話週期）和 `run`（單次調用）。影片透過程式碼展示，當簡訊代理超出設定的額度時，可以設定不同的退出行為：`error`（直接拋出錯誤並中止）或 `continue`（允許在額度內的呼叫成功，其餘的則失敗並優雅地告知使用者）。
- **結尾**：結論是，任何與付費或有速率限制的 API 互動的代理，都應該從第一天起就加入這個中介層。它是一個確保代理行為在預算內、避免失控的關鍵防護機制。

## 關鍵見解
1.  **成本控制是關鍵**：賦予代理強大工具的同時，必須有機制來控制其使用，否則很容易產生高昂的營運成本。
2.  **宣告式的防護機制**：Tool Call Middleware 提供了一種乾淨、宣告式的方法來設定限制，無需在系統提示中寫入複雜的硬編碼規則。
3.  **兩種限制範圍**：`thread` 限制控制整個對話週期的總呼叫次數，而 `run` 限制則控制單次調用（例如一次處理多個並行請求）的呼叫次數。
4.  **優雅的失敗處理**：透過將退出行為設定為 `continue`，系統可以在達到額度上限時，只完成部分任務並清楚地向使用者解釋情況，而不是完全崩潰。
5.  **第一天就該導入**：對於任何涉及付費服務（如資料庫、簡訊、搜尋 API）的代理，這個中介層應被視為標準配備，而非事後補救措施。

## 精彩時刻
- **一針見血的開場**：「你是否也曾建立過一個會瘋狂呼叫你 API 的代理？」
- **生動的比喻**：「如果你的代理在用戶只有兩則簡訊額度時發了五則，猜猜誰來買單？」
- **實際展示的威力**：在 `continue` 模式下，代理成功發送了兩則簡訊，並回報：「我成功發送了兩則訊息，但其餘的因額度限制而被拒絕。」這完美展示了該功能的實用性。

---

# LangChain Tutorial: Control Your AI Agent with Tool Call Middleware

## TL;DR
This video introduces LangChain's "Tool Call Middleware," a feature that lets you set rate limits, credit caps, or usage limits on an agent's tools without hard-coding guardrails in the system prompt. This effectively prevents agents from overusing paid APIs and helps control costs.

## Story Flow
- **Beginning**: The video starts by highlighting a common problem: AI agents can go wild with API calls, leading to unexpectedly high costs. The speaker uses an SMS-sending agent as an example—if a user has credit for two messages but the agent sends five, the developer foots the bill.
- **Middle**: To solve this, the video explains the concept of the Tool Call Middleware. It hooks into the agent loop right after the model decides to call a tool, allowing it to intercept and count calls. Developers can configure limits for specific tools with two scopes: `thread` (the entire conversation) and `run` (a single invocation). A code demo shows that when an SMS agent exceeds its credit limit, it can have different exit behaviors: `error` (throws an error and stops) or `continue` (allows calls within the limit to succeed while gracefully failing the rest).
- **End**: The conclusion is that any agent interacting with paid or rate-limited APIs should have this middleware implemented from day one. It's a critical guardrail to keep the agent's behavior within budget and prevent it from running out of control.

## Key Insights
1.  **Cost Control is Crucial**: Giving agents powerful tools requires mechanisms to control their usage; otherwise, operational costs can quickly skyrocket.
2.  **Declarative Guardrails**: The Tool Call Middleware offers a clean, declarative way to set limits without writing complex, hard-coded rules into the system prompt.
3.  **Two Types of Limits**: The `thread` limit controls the total number of calls over an entire conversation, while the `run` limit controls calls within a single invocation (e.g., handling multiple parallel requests at once).
4.  **Graceful Failure Handling**: By setting the exit behavior to `continue`, the system can partially complete a task when a limit is hit and clearly explain the situation to the user instead of crashing entirely.
5.  **Implement on Day One**: For any agent involving paid services (databases, SMS, search APIs, etc.), this middleware should be considered a standard feature, not an afterthought.

## Notable Moments
- **The Hook**: "Have you ever built an agent that just goes nuts with your API calls?"
- **The Analogy**: "If your agent sends five messages when your user actually has just credit for two, guess who pays the bill?"
- **The Powerful Demo**: In `continue` mode, the agent successfully sends two messages and reports back, "I was successfully able to send two messages but the other were restricted due to credit limits," perfectly demonstrating the feature's practical value.
